# Agent Instructions for Annie Mei

This document provides context for AI coding agents working on the Annie Mei Discord bot.

## Project Summary

Annie Mei is a Rust Discord bot using Serenity 0.11 that fetches anime/manga data from AniList and theme songs from MyAnimeList/Spotify. Users interact via Discord slash commands.

## Technology Stack

| Component | Technology |
|-----------|------------|
| Language | Rust 2021 Edition |
| Discord | Serenity 0.11 |
| Database | PostgreSQL + Diesel ORM |
| Cache | Redis |
| HTTP | Reqwest (blocking) |
| Async | Tokio |
| Logging | tracing + tracing-subscriber |
| Errors | Sentry |

## Project Layout

```
src/
├── commands/        # Slash command implementations
├── models/          # Data types, DB models, API responses
├── utils/           # Shared utilities, API clients, DB helpers
├── schema.rs        # Diesel schema (AUTO-GENERATED - never edit)
└── main.rs          # Bot entry point and event routing
migrations/          # Diesel SQL migrations
```

## Essential Commands

```bash
cargo build              # Compile debug build
cargo build --release    # Compile optimized build
cargo test               # Run test suite
cargo clippy             # Run linter
cargo fmt                # Format code
cargo check              # Fast type checking
diesel migration run     # Apply database migrations
```

## Conventions to Follow

### Code Style
- Run `cargo fmt` before committing
- Run `cargo clippy` and fix warnings
- Use `tracing` macros for logging (`info!`, `debug!`, `error!`)
- Add `#[instrument]` attribute to functions for tracing spans
- Prefer `?` operator over `.unwrap()` for error handling

### Git Commits
- Use conventional commit format: `type: description`
- Types: `feat`, `fix`, `docs`, `chore`, `refactor`, `test`

### Adding Commands
1. Create module in `src/commands/`
2. Implement `register()` for slash command definition
3. Implement `run()` for command execution
4. Export in `src/commands/mod.rs`
5. Register in `main.rs` `ready` event
6. Add match arm in `main.rs` `interaction_create`

### Database Changes
1. Generate migration: `diesel migration generate name`
2. Write SQL in `migrations/*/up.sql` and `down.sql`
3. Run: `diesel migration run`
4. `src/schema.rs` updates automatically

### Async/Blocking Patterns
- Discord interactions are async
- External API calls use blocking reqwest
- Wrap blocking code in `tokio::task::spawn_blocking`
- Always `defer()` interactions before long operations

## File Patterns

| Pattern | Location |
|---------|----------|
| Slash commands | `src/commands/<name>/command.rs` |
| API response types | `src/models/anilist_*.rs` |
| Database models | `src/models/db/*.rs` |
| API clients | `src/utils/requests/*.rs` |
| Constants | `src/utils/statics.rs` |
| GraphQL queries | `src/commands/<name>/queries.rs` |

## Testing

- Unit tests go in the same file as the code being tested
- Integration tests go in `tests/` directory
- Mock external APIs in tests
- Run `cargo test` to execute all tests

## Common Pitfalls

1. **Don't edit `src/schema.rs`** - It's auto-generated by Diesel
2. **Always defer long operations** - Discord has a 3-second response window
3. **Use spawn_blocking for HTTP/DB** - Reqwest blocking client blocks the thread
4. **Check environment variables** - Bot requires multiple env vars to run

## Environment Requirements

Required environment variables:
- `DISCORD_TOKEN` - Bot token from Discord Developer Portal
- `SENTRY_DSN` - Sentry project DSN
- `ENV` - Environment name
- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `RSPOTIFY_CLIENT_ID` - Spotify API client ID
- `RSPOTIFY_CLIENT_SECRET` - Spotify API client secret

