on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or SHA to deploy"
        required: true
        default: "main"
  push:
    paths-ignore:
      - "**/README.md"
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

name: ARM64 build-release

permissions:
  contents: write

jobs:
  build:
    name: Build ARM64
    runs-on: ubuntu-24.04-arm
    container: rust:1-bullseye
    env:
      CARGO_TERM_COLOR: always
      RUSTC_WRAPPER: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}
      - name: Install Rust
        run: rustup update stable && rustup default stable
      - name: Install dependencies
        run: apt-get update && apt-get install -y libpq-dev
      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"
          prefix-key: "annie-mei"
          shared-key: "cargo"
      - name: Build
        run: cargo build --release
      - name: Upload debug symbols to Sentry
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli debug-files upload --include-sources target/release/
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      - name: Prepare artifact
        run: cp target/release/annie-mei ./annie-mei
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: annie-mei-arm64
          path: |
            annie-mei
            mei.jpg
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/release/annie-mei
            LICENSE
            mei.jpg

  deploy:
    name: Deploy to Oracle Cloud
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: annie-mei-arm64
      - name: Copy binary to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          source: "annie-mei,mei.jpg"
          target: /opt/annie-mei/annie-mei.new
          strip_components: 0
      - name: Restart service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            cd /opt/annie-mei || exit 1
            chmod +x annie-mei.new/annie-mei
            # Validate new binary before stopping service
            if ! test -x ./annie-mei.new/annie-mei; then
              echo "Binary validation failed"
              exit 1
            fi
            ldd_output=$(ldd ./annie-mei.new/annie-mei 2>&1) || {
              echo "Binary validation failed"
              echo "$ldd_output"
              exit 1
            }
            if echo "$ldd_output" | grep -q "not found"; then
              echo "Binary validation failed"
              exit 1
            fi
            if ! test -f ./annie-mei.new/mei.jpg; then
              echo "Missing mei.jpg"
              exit 1
            fi
            # Backup current binary
            cp annie-mei annie-mei.backup || true
            # Stop, replace, start
            sudo systemctl stop annie-mei
            mv annie-mei.new/annie-mei annie-mei
            cp annie-mei.new/mei.jpg mei.jpg
            rm -rf annie-mei.new
            sudo systemctl start annie-mei
            # Verify service started
            sleep 2
            sudo systemctl is-active annie-mei || { 
              echo "Service failed to start, rolling back"
              mv annie-mei.backup annie-mei
              sudo systemctl start annie-mei
              exit 1
            }
            rm -f annie-mei.backup
